# 农机检测后端部署指南

## 服务器信息
- **IP地址**: 124.222.174.116
- **账号**: ubuntu
- **密码**: Gqt123$%^
- **部署目录**: /opt/nongji_app
- **运行端口**: 8062

## 部署步骤

### 1. 首次部署（以root用户执行）

连接服务器后，切换到root用户：
```bash
sudo -i
```

运行初始化脚本：
```bash
# 下载并运行初始化脚本
curl -fsSL https://raw.githubusercontent.com/zzbazzzbaz/nongji-backend/main/server_init.sh -o /tmp/server_init.sh
chmod +x /tmp/server_init.sh
/tmp/server_init.sh
```

或者手动执行以下步骤：
```bash
# 1. 更新系统
apt update && apt upgrade -y

# 2. 安装依赖
apt install -y python3 python3-pip python3-venv git curl lsof

# 3. 安装uv包管理器（使用国内镜像）
export UV_INDEX_URL="https://pypi.tuna.tsinghua.edu.cn/simple/"
curl -LsSf https://astral.sh/uv/install.sh | sh
export PATH="/root/.local/bin:$PATH"

# 4. 创建应用目录
mkdir -p /opt/nongji_app
chown -R ubuntu:ubuntu /opt/nongji_app

# 5. 克隆代码
git clone https://github.com/zzbazzzbaz/nongji-backend.git /opt/nongji_app
chown -R ubuntu:ubuntu /opt/nongji_app

# 6. 设置权限
chmod +x /opt/nongji_app/deploy.sh
```

### 2. 配置环境变量

编辑环境配置文件：
```bash
nano /opt/nongji_app/.env
```

配置内容：
```env
# Django配置
SECRET_KEY=your-production-secret-key-change-this
DEBUG=False

# 阿里云OCR (如需要请填写)
ALIBABA_CLOUD_ACCESS_KEY_ID=
ALIBABA_CLOUD_ACCESS_KEY_SECRET=
```

### 3. 配置Git凭据（可选）

如果遇到Git权限问题，需要配置GitHub凭据：
```bash
# 切换到ubuntu用户
su - ubuntu

# 配置Git凭据
git config --global credential.helper store
echo "https://zzbazzzbaz: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@github.com" > ~/.git-credentials
```

### 4. 运行自动部署脚本

切换到ubuntu用户并运行部署：
```bash
su - ubuntu
cd /opt/nongji_app
./deploy.sh
```

## 部署脚本功能

### deploy.sh 脚本支持的操作：

```bash
# 完整部署（默认）
./deploy.sh

# 仅启动服务
./deploy.sh start

# 仅停止服务  
./deploy.sh stop

# 重启服务
./deploy.sh restart

# 查看状态
./deploy.sh status

# 查看日志
./deploy.sh logs

# 显示帮助
./deploy.sh help
```

### 脚本自动执行的步骤：

1. **代码更新** - 最多尝试100次从GitHub拉取最新代码
2. **依赖安装** - 使用uv包管理器安装Python依赖（国内镜像加速）
3. **数据库迁移** - 生成并应用数据库迁移文件
4. **进程管理** - 杀掉旧的Gunicorn进程
5. **服务启动** - 使用Gunicorn在8062端口启动服务

## 服务管理

### 查看服务状态
```bash
cd /opt/nongji_app
./deploy.sh status
```

### 查看日志
```bash
cd /opt/nongji_app
./deploy.sh logs
```

### 手动重启
```bash
cd /opt/nongji_app
./deploy.sh restart
```

### 手动停止
```bash
cd /opt/nongji_app
./deploy.sh stop
```

## 防火墙配置

如果无法访问，需要开放8062端口：
```bash
# 以root用户执行
sudo -i
ufw allow 8062
```

## 访问地址

部署成功后，可通过以下地址访问：
- **API地址**: http://124.222.174.116:8062
- **管理后台**: http://124.222.174.116:8062/admin/

## 常见问题

### 1. Git权限问题
如果遇到Git权限错误，请检查GitHub凭据配置。

### 2. 依赖安装失败
脚本已配置国内镜像，如果仍有问题，可手动设置：
```bash
export UV_INDEX_URL="https://pypi.tuna.tsinghua.edu.cn/simple/"
```

### 3. 端口被占用
脚本会自动杀掉占用8062端口的进程，如果仍有问题：
```bash
sudo lsof -i:8062
sudo kill -9 <PID>
```

### 4. 数据库迁移失败
检查数据库文件权限：
```bash
sudo chown ubuntu:ubuntu /opt/nongji_app/db.sqlite3
```

## 日志文件位置

- **Gunicorn日志**: /opt/nongji_app/gunicorn.log
- **访问日志**: /opt/nongji_app/access.log
- **PID文件**: /opt/nongji_app/gunicorn.pid

## 生产环境优化建议

1. **配置Nginx反向代理**（可选）
2. **配置SSL证书**（可选）
3. **设置定时备份**（可选）
4. **配置监控告警**（可选）
